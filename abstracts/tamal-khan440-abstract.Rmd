---
title: "Adult age and Red triage"
author: "TAMAL"
date: "06/06/2020"
output:
  word_document: default
  html_document: default
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE, results='asis', message=FALSE}
library(knitr)
library(dplyr)
library(psych)
library(data.table) 
library(tableone)
library(epiDisplay)
library(tigerstats)
library(splitstackshape)
library(tidyverse)
library(tidyr)
opts_chunk$set(echo = FALSE)
```
```
```

## Introduction
It is important to triage trauma patients because proper triaging indicate level of care required for the patients. The red triage level is used for very serious patients where green triage is for minor injury.So triaging is very important part of trauma care system.Present data shows that trauma increasing in adult age rather than senior adult.

## Aim
Aim of the study is To characterise trauma patients triaged red with special reference to their age distribution.

## Study design
Data patients triage red were extracted from TTRIS data set of centre 1515 then retrospective analysis of a prospective cohort of trauma patients with age division.


## Methods
Data of triaged red patients extract out from the data set of TTRIS study project. A retrospective cohort analysis of the data will performed using R with respect to age group. 

## Result
```{r}
# Select data directory

TTRIS_1515 <- read.csv("C:/Users/Tamal/OneDrive/Documents/TTRIS_1515.csv")

# Summary of age in selected data set with histogram

summary(TTRIS_1515$age)
hist(TTRIS_1515$age, col='grey',xlab='Age', main='Age of patients')

# Summary of triage category with histogram

summary(TTRIS_1515$tc)
hist(TTRIS_1515$tc, col='grey',xlab='tc', main='Triage of patients')

##  Selection of triage category

summary(TTRIS_1515$tc == 3)
table(TTRIS_1515$tc == 3)
red <- subset(x=TTRIS_1515, subset = TTRIS_1515$tc == 3)
table(red$tc)

## Percentage

mean(TTRIS_1515$tc == 3)*100

# Selection of adult age in this specified triage category
table(red$age <61)
mean(red$age <61)*100 
fd_red <- subset(x=red, subset = red$age <61)

# Not admitted patients in this triage

table(fd_red$doa)
table(fd_red$doa == 0)
table(fd_red$toa == 0)
table(fd_red$doa == 999)

## Percentage of patients not admitted

mean(fd_red$doa == 0)*100
mean(fd_red$doa == 999)*100

# Sex

table(fd_red$sex == 1)
table(fd_red$sex == 0)

## Percentage

mean(fd_red$sex == 1)*100
mean(fd_red$sex == 0)*100

# Mode of transport

table(fd_red$mot)
hist(fd_red$mot, col='red',xlab='mot', main='Mode of transport')
table(fd_red$mot == 0)
table(fd_red$mot == 1)
table(fd_red$mot == 2)
table(fd_red$mot == 3)
table(fd_red$mot == 999)

## percentage

mean(fd_red$mot == 0)*100
mean(fd_red$mot == 1)*100
mean(fd_red$mot == 2)*100
mean(fd_red$mot == 3)*100
mean(fd_red$mot == 999)*100

# Transfer status

table(fd_red$tran)

## percentage

mean(fd_red$tran == 0)*100
mean(fd_red$tran == 1)*100

# Type of Injury

table(fd_red$tyi)
table(fd_red$tyi == 0)
table(fd_red$tyi == 1)

## Percentage

mean(fd_red$tyi == 0)*100
mean(fd_red$tyi == 1)*100

# Mode of Injury
table(fd_red$moi)

## GCS range selection
table(fd_red$gcs <15)
table(fd_red$gcs <13)
table(fd_red$gcs <10)
table(fd_red$gcs <8)
table(fd_red$gcs <6)
table(fd_red$gcs <4)
table(fd_red$egcs ==1)
mean(fd_red$egcs == 1)*100
mean(fd_red$egcs == 2)*100
mean(fd_red$egcs == 3)*100
mean(fd_red$egcs == 4)*100
mean(fd_red$vgcs == 1)*100
mean(fd_red$vgcs == 2)*100
mean(fd_red$vgcs == 3)*100
mean(fd_red$vgcs == 4)*100
mean(fd_red$vgcs == 5)*100
mean(fd_red$mgcs == 1)*100
mean(fd_red$mgcs == 2)*100
mean(fd_red$mgcs == 3)*100
mean(fd_red$mgcs == 4)*100
mean(fd_red$mgcs == 5)*100
mean(fd_red$mgcs == 6)*100

## RR parameter value

table(fd_red$rr)
hist(fd_red$rr, col='blue',xlab='rr', main='Respiratory rate')

## SBP parameter

table(fd_red$sbp)
hist(fd_red$sbp, col='grey',xlab='sbp', main='Systolic Blood pressure')

## DBP parameter

table(fd_red$dbp)
hist(fd_red$dbp, col='violet',xlab='dbp', main='Diastolic Blood pressure')

## Hr parameter

table(fd_red$hr)
hist(fd_red$hr, col='green',xlab='hr', main='Heart Rate')

## AVPU

table(fd_red$avpu == 0)
table(fd_red$avpu == 1)
table(fd_red$avpu == 2)
table(fd_red$avpu == 3)
table(fd_red$avpu == 99)
table(fd_red$avpu == 999)

### Percentage

mean(fd_red$avpu == 0)*100
mean(fd_red$avpu == 1)*100
mean(fd_red$avpu == 2)*100
mean(fd_red$avpu == 3)*100
mean(fd_red$avpu == 99)*100
mean(fd_red$avpu == 999)*100

## Oxygen Support

table(fd_red$vo2)
table(fd_red$vo2 == 0)
table(fd_red$vo2 == 1)

### Percentage

mean(fd_red$vo2 == 0)*100
mean(fd_red$vo2 == 1)*100
table(fd_red$nsi)

## Serious Injury

table(fd_red$nsi == 1)
table(fd_red$nsi == 2)

### Percentage

mean(fd_red$nsi == 1)*100
mean(fd_red$nsi == 2)*100

## CT unavailable

### Not done
table(fd_red$dct == 0)
table(fd_red$tct == 0)
#### Percentage
mean(fd_red$dct == 0)*100
mean(fd_red$tct == 0)*100

### Report unknown
table(fd_red$dct == 999)
table(fd_red$tct == 999)

#### Percentage
mean(fd_red$dct == 999)*100
mean(fd_red$tct == 999)*100

## USG Unavailable

### Not done
table(fd_red$dus == 0)
table(fd_red$tus == 0)

#### Percentage
mean(fd_red$dus == 0)*100
mean(fd_red$tus == 0)*100

### Report unknown
table(fd_red$dus == 999)
table(fd_red$tus == 999)

#### Percentage
mean(fd_red$dus == 999)*100
mean(fd_red$tus == 999)*100

## Intubation not done

table(fd_red$di == 0)
table(fd_red$di == 999)
mean(fd_red$di == 0)*100
mean(fd_red$di == 999)*100

## Mechanical ventilation not done

table(fd_red$dmv == 0)
table(fd_red$dmv == 999)
mean(fd_red$dmv == 0)*100
mean(fd_red$dmv == 999)*100

## ICU admission not done

table(fd_red$daicu == 0)
table(fd_red$daicu == 999)
mean(fd_red$daicu == 0)*100
mean(fd_red$daicu == 999)*100

## Surgery not done

table(fd_red$dos == 0)
table(fd_red$dos == 999)
mean(fd_red$dos == 0)*100
mean(fd_red$dos == 999)*100

## Injuries

### External Injury

table(fd_red$einj1)
table(fd_red$einj2)
table(fd_red$einj3)
table(fd_red$einj4)
table(fd_red$einj5)
table(fd_red$einj6)

# Hospital Disposition in red triage
table(red$hd == 0)
table(red$hd == 1)
table(red$hd == 2)
table(red$hd == 3)
table(red$hd == 999)

## Percentage

mean(red$hd == 0)*100
mean(red$hd == 1)*100
mean(red$hd == 2)*100
mean(red$hd == 3)*100
mean(red$hd == 999)*100

##In case of Adult Age

table(fd_red$hd == 0)
table(fd_red$hd == 1)
table(fd_red$hd == 2)
table(fd_red$hd == 3)
table(fd_red$hd == 999)

### Percentage

mean(fd_red$hd == 0)*100
mean(fd_red$hd == 1)*100
mean(fd_red$hd == 2)*100
mean(fd_red$hd == 3)*100
mean(fd_red$hd == 999)*100

## Followups of patients not done in this perticular data set

### In 24 hours

table(fd_red$s24h == 999)

#### Percentage

mean(fd_red$s24h == 999)*100

### In 30 days

table(fd_red$s30d == 999)

#### Percentage

mean(fd_red$s30d == 999)*100

### In 6 months

table(fd_red$s6m == 999)

#### Percentage

mean(fd_red$s6m == 999)*100

## patients dead in 24 hour of arrival

table(fd_red$s24h == 1)

### Percentage

mean(fd_red$s24h == 1)*100

## Patients dead in 30 days of arrival

table(fd_red$s30d == 1)

### Percentage

mean(fd_red$s30d == 1)*100

## Patients dead in 6 months of arrival

table(fd_red$s6m == 1)

### Percentage

mean(fd_red$s6m == 1)*100
```

Total number patients available for analysis n= 5618, triage red category patients are 272 under this category so 4% patients(red dataset) are triage red, adult age patients under this triage are 219 percentage is 80(fd_red data set),male patients are 187 i.e 85.38% and female patients are 32 i.e 14.61%. Admitted patients are 183 patients i.e 83.66% and non admitted 36 patients i.e 16.34%. Patients . 

Patients Patients Discharged Alive after treatment is  11 i.e 4%, Number of patients death occured in this triage category are 202 i.e 74.26, Transfered to another hospital 23 i.e 8.45%, Discharge against medical advise 16 i.e 5.88%, unknown 20 i.e 7.35%.

In adult age in red triage Discharged Alive after treatment is  10 i.e 4.56%, Number of patients death occured in this triage category are 158 i.e 72.14, Transfered to another hospital 19 i.e 8.67%, Discharge against medical advise 15 i.e 6.84%, unknown 17 i.e 7.76%.   

##Conclusion

So from this data set it can conclude that death rate of of triage red is very much high in this perticular hospital.


## Results using method 2

```{r Data_cleaning_manipulation, warning=FALSE, results='hide'}

# Get data directory

data.dir <- getOption("data.dir")
if (is.null(data.dir))
    stop ("Please set the directory where the data is kept using options(data.dir = \"<path to data directory>\")")

## datatable with ICD
a <- data.table::fread(file.path(data.dir, "TTRIS.csv"))

## Rearranging columns
dt <- a %>% dplyr::select(centre,pid,cr,qcrec:vsqs,ic:toa,egcs:rr,nsi,tc,dvsr:tvsr,dus:testvar,locked,doi_toi:valid)

extra_col <- dt %>% dplyr::select(doi_toi:valid)

# Creating age groups
agebreaks <- c(17,25,45,65,98)
agelabels <- c("18-24","25-44","45-64","65+")
dt$agegrp <-cut(dt$age,
                breaks = agebreaks,
                right = FALSE,
                labels = agelabels)

# Mechanism of Injury
moi.collapsed <- moi <- as.character(dt$moi)
 get_icd_range <- function(first.char, start.number, end.number) {
    icd.range <- paste0(
        paste0(
            "^",
            first.char,
            stringr::str_pad(start.number:end.number, 2, pad = "0"),
            "[0-9]?$"),
        collapse = "|")
    return (icd.range)
 }
 
 icd.ranges <- list(c("Transport accident" = get_icd_range("V", 0, 99)),
                   c("Fall" = get_icd_range("W", 0, 19)),
                   c("Animal bite" = get_icd_range("W", 50, 64)),
                   c("Assault" = paste0(get_icd_range("X", 85, 99), "|", get_icd_range("Y", 0, 9))))
for(icd.range in icd.ranges) moi.collapsed[grep(icd.range, moi)] <- names(icd.range)
moi.collapsed[!(moi.collapsed %in% sapply(icd.ranges, attr, "names"))] <- "Other"
a$moi.collapsed <- as.factor(moi.collapsed)

## New variable 'GCS' to the dataset
gcs <- with(dt, egcs + vgcs + mgcs)
gcs <- replace(gcs, gcs > 15, NA)
gcspv <- gcs
gcspv[gcs >= 13] <- 4
gcspv[gcs >= 9 & gcs < 13] <- 3
gcspv[gcs >= 6 & gcs < 9] <- 2
gcspv[gcs >= 4 & gcs < 6] <- 1
gcspv[gcs < 4] <- 0

## RR parameter value for calculating RTS
rr <- with(dt,replace(rr, rr == 999, NA))
rrpv <- rr
rrpv[rr >= 10 & rr <= 29] = 4
rrpv[rr > 29] = 3
rrpv[rr >= 6 & rr <= 9] = 2
rrpv[rr >= 1 & rr <= 5] = 1
rrpv[rr == 0] = 0

## SBP parameter value for calculating RTS
sbp <- with(dt,replace(sbp, sbp == 999, NA))
sbppv <- sbp
sbppv[sbp > 89] <- 4
sbppv[sbp >=76 & sbp <= 89] <- 3
sbppv[sbp >= 50 & sbp <= 75] <- 2
sbppv[sbp >= 1 & sbp <= 49] <- 1
sbppv[sbp == 0] <- 0

## Formula for calculating RTS
dt$rts = round(0.9368*as.numeric(gcspv) + 
               0.7326*as.numeric(sbppv) + 
               0.2908*as.numeric(rrpv), digits = 0)

## Complete record results

dt$s24h <- replace(dt$s24h, dt$s24h == 999, 888) ## follow up not done
dt$s30d <- replace(dt$s30d, dt$s30d == 999, 888)
dt$s6m <- replace(dt$s6m, dt$s6m == 999, 888)
dt$s <- replace(dt$s, dt$s == 999, 888)

## Converting rest of the 999s to NA
dt[] <- dt[] %>% 
    mutate_all(funs(na_if(.,"999")))
missing.data.list <- lapply(dt, function(column) {
    n.na <- sum(is.na(column))
    p.na <- round((n.na/length(column)) * 100)
    missing <- data.frame("Count" = n.na, "Percentage" = p.na)
    return (missing)
})
missing.data <- do.call(rbind, missing.data.list)
maximum.missing <- rownames(missing.data)[missing.data$Count == max(missing.data$Count)]
complete.index <- complete.cases(dt)
n.incomplete <- sum(!complete.index)
p.incomplete <- round((n.incomplete/nrow(dt)) * 100)

dtt <- dt[complete.index, ]

```

```{r result, warning=FALSE, message=FALSE}

# Created a dataframe of triage category red
sskm <- subset(x=dtt,subset = dtt$tc == 3)

# Number of records
dm <- as.numeric(nrow(sskm))

# Age
mean_age <- round(mean(sskm$age),2)
stddev_age <- round(sd(sskm$age),2)
nm_age <- sum(sskm$agegrp != "65+")
percent_agebelow65 <- round(mean(sskm$agegrp != "65+") * 100, 2)
calculate_n_p <- function(level.name, factor.var){
    assert_that(is.character(level.name))
    assert_that(is.factor(factor.var))
    nm <- sum(factor.var == level.name)
    percent <- round((nm/dm) * 100,2)
    return.list <-list(nm = nm, percent = percent)
    return.list
}
